#!/bin/csh -f
# Genbank Daily Non-cumulative Update
#

cd `dirname $0` && source ./Configuration
setenv SCRIPT_NAME `basename $0`
setenv LOG ${MIRRORLOG}/${SCRIPT_NAME}.log
setenv LOCAL_DIR ${DATADOWNLOADS}/genbank_daily
mkdir -p ${MIRRORLOG}
mkdir -p ${DATADOWNLOADS}/ftp.ncbi.nih.gov/genbank
mkdir -p ${DATADOWNLOADS}/genbank/gb_daily-nc

rm -f ${LOG}
touch ${LOG}
echo "$0" >> ${LOG}
echo `date` >> ${LOG}

# Full path the read/write lock directory
setenv LOCK_DIR ${LOCAL_DIR}

# attempt to set genbank write lock
#mirror_lock wlock mirror_wget ${LOCK_DIR} >> ${LOG}
if ($status != 0) then
  echo "mirror_lock is being used...exiting ${SCRIPT_NAME}" >> ${LOG}
  echo "See logs at ${LOG}">> ${LOG}
  echo "Stop Time: `date`" >> ${LOG}
  exit (1)
endif

cd ${LOCAL_DIR}

# PATTERN for GB Non-Cumulatives
setenv GBNC_URL 'ftp://ftp.ncbi.nih.gov/genbank/daily-nc/nc*\.flat\.gz'

# full path to log files
setenv GBNC_LOG ${MIRRORLOG}/ftp.ncbi.nih.gov.gbnc.env.log

#
# wget
# -S = print the headers sent by HTTP servers and responses sent by FTP servers.
# -o = full path to log file
# -O = full path to output file
# -t = number of retries
# -r = reverse
# -k 7 = sort by the 7th column
# -m = Turn on options suitable for mirroring. This option turns on recursion 
#    and time-stamping, sets infinite recursion depth and keeps FTP 
#    directory listings. It is currently equivalent to .-r -N -l 
#    inf --no-remove-listing.. 

wget -o ${GBNC_LOG} -S -t 10 -nd -m "${GBNC_URL}"

#unluck wget lock
cd ${MIRROR_WGET}
#mirror_lock unlock mirror_wget ${LOCK_DIR} >> ${LOG}
echo `date` >> ${LOG}
echo "Program complete" >> ${LOG}

